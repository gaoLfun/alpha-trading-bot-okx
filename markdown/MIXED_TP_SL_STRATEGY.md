# 混合止盈止损策略实现

## 需求背景

用户希望实现以下策略：
- **止盈 (Take Profit)**: 基于当前市场价格动态调整，跟随价格上涨
- **止损 (Stop Loss)**: 基于持仓均价固定不变，确保最小损失

## 策略逻辑

### 混合策略特点：
1. **动态止盈**: 随着市场价格上涨，止盈价位也相应上调，锁定更多利润
2. **固定止损**: 止损价位始终基于持仓成本价计算，确保最大损失可控
3. **风险控制**: 在保护本金的同时，让利润有更大的增长空间

### 计算公式：

#### 多头仓位 (LONG):
- 止盈价 = 当前价格 × (1 + 止盈百分比)
- 止损价 = 持仓均价 × (1 - 止损百分比)

#### 空头仓位 (SHORT):
- 止盈价 = 当前价格 × (1 - 止盈百分比)
- 止损价 = 持仓均价 × (1 + 止损百分比)

## 代码实现

### 1. 更新现有持仓的止盈止损 (`_check_and_update_tp_sl`)

```python
# 混合策略：止盈基于当前价格（动态），止损基于持仓均价（固定）
if current_position.side == TradeSide.LONG:
    # 多头：止盈在上方，止损在下方
    new_take_profit = current_price * (1 + take_profit_pct)  # 止盈：基于当前价（动态）
    new_stop_loss = entry_price * (1 - stop_loss_pct)      # 止损：基于持仓均价（固定）
else:
    # 空头：止盈在下方，止损在上方
    new_take_profit = current_price * (1 - take_profit_pct)  # 止盈：基于当前价（动态）
    new_stop_loss = entry_price * (1 + stop_loss_pct)      # 止损：基于持仓均价（固定）
```

### 2. 新仓位的止盈止损设置 (`_set_tp_sl`)

```python
# 新仓位策略：止盈基于当前价（动态），止损基于入场价（固定）
entry_price = order_result.average_price

if side == TradeSide.BUY:
    # 多头：止盈在上方，止损在下方
    take_profit = current_price * (1 + take_profit_pct)  # 止盈：基于当前价（动态）
    stop_loss = entry_price * (1 - stop_loss_pct)      # 止损：基于入场价（固定）
else:
    # 空头：止盈在下方，止损在上方
    take_profit = current_price * (1 - take_profit_pct)  # 止盈：基于当前价（动态）
    stop_loss = entry_price * (1 + stop_loss_pct)      # 止损：基于入场价（固定）
```

## 配置选项

### 投资类型与默认百分比：

| 投资类型 | 止盈百分比 | 止损百分比 | 特点 |
|---------|-----------|-----------|------|
| conservative | 6% | 2% | 稳健型，低波动 |
| moderate | 8% | 3% | 中等型，平衡策略 |
| aggressive | 12% | 5% | 激进型，高风险高收益 |

### 配置方法：
只需在 `.env` 文件中设置：
```bash
INVESTMENT_TYPE=conservative  # 或其他类型
```

## 日志输出示例

### 更新现有持仓：
```
[时间] 混合策略设置 - 持仓均价: $87,121.80, 当前价格: $86,232.70
[时间] - 止盈: $91,406.66 (基于当前价 +6.0%)
[时间] - 止损: $85,379.36 (基于持仓均价 -2.0%)
```

### 新仓位设置：
```
[时间] 混合策略 - 入场价: $86,232.70, 当前价: $86,500.00
[时间] - 止盈: $91,690.00 (基于当前价 +6.0%)
[时间] - 止损: $84,507.64 (基于入场价 -2.0%)
```

## 策略优势

1. **利润最大化**: 止盈跟随价格上涨，不会过早平仓
2. **风险可控**: 止损固定在成本价附近，最大损失确定
3. **适应性强**: 适用于不同市场环境和投资偏好
4. **操作简单**: 一键切换投资类型，自动应用对应参数

## 注意事项

1. **止损固定**: 止损价位不会随市场变化而调整，确保最大损失可控
2. **止盈动态**: 止盈价位会根据当前市场价格实时调整
3. **加仓影响**: 加仓后会重新计算基于新平均价格的止损位
4. **滑点考虑**: 实际成交价格可能与触发价格有轻微差异

## 使用建议

1. **震荡市场**: 建议使用 conservative 类型，较小的百分比避免频繁触发
2. **趋势市场**: 可使用 moderate 或 aggressive 类型，让利润有更大增长空间
3. **高波动品种**: 可适当增大止损百分比，避免正常波动触发止损
4. **低波动品种**: 可使用较小的百分比设置，提高资金利用率

这种混合策略既保护了本金安全，又让利润有充分的上涨空间，是一种比较实用的风险管理方法。现在系统已经完整实现了这一策略，用户可以根据自己的风险偏好选择相应的投资类型。