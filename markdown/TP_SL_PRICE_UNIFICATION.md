# TP/SL价格计算统一化

## 问题
系统存在两个不同的TP/SL价格计算逻辑：
1. AI决策显示：基于当前价格 ($86,232.70)
   - 止盈: $91,406.66 (+6.0%)
   - 止损: $84,508.05 (-2.0%)

2. 仓位更新显示：基于持仓均价 ($87,121.80)
   - 止盈: $92,349.11 (+6.0%)
   - 止损: $85,379.36 (-2.0%)

## 解决方案
统一使用当前市场价格计算TP/SL，原因：

1. **风险管理更合理**：基于当前价格能更好反映当前市场风险
2. **与AI决策一致**：确保策略执行与信号生成逻辑统一
3. **更直观的盈亏计算**：投资者更容易理解基于当前价格的盈亏

## 代码修改

### 1. `_check_and_update_tp_sl` 方法
```python
# 原代码：基于持仓均价
new_take_profit = entry_price * 1.06
new_stop_loss = entry_price * 0.98

# 新代码：基于当前价格
new_take_profit = current_price * 1.06
new_stop_loss = current_price * 0.98
```

### 2. `_set_tp_sl` 方法
```python
# 原代码：基于订单均价
take_profit = entry_price * 1.06
stop_loss = entry_price * 0.98

# 新代码：基于当前价格
take_profit = current_price * 1.06
stop_loss = current_price * 0.98
```

### 3. 日志显示更新
```python
# 原日志：基于持仓均价
logger.info(f"基于持仓均价 ${entry_price:.2f} 设置止盈止损:")

# 新日志：基于当前价格
logger.info(f"基于当前价格 ${current_price:.2f} 设置止盈止损:")
```

## 预期效果

修改后，两个地方的TP/SL价格将保持一致：
- 当前价格: $86,232.70
- 止盈: $86,232.70 × 1.06 = $91,406.66
- 止损: $86,232.70 × 0.98 = $84,508.05

## 好处

1. **一致性**：AI信号和订单执行使用相同基准
2. **透明度**：用户更容易理解价格逻辑
3. **灵活性**：能更好适应市场变化
4. **风险控制**：基于当前价格更合理

## 注意事项

1. 对于已有仓位，TP/SL会随市场价格调整
2. 需要确保当前价格获取准确
3. 在高波动市场中，TP/SL价格会频繁变化

修改完成后，系统将统一使用当前市场价格作为TP/SL计算的基准，确保策略执行的一致性。