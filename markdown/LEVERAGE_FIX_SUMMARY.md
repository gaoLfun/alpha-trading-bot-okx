# 杠杆设置增强功能总结

## 问题
系统初始化时尝试设置杠杆失败，错误信息：
```
设置杠杆失败: okx {"code":"59669","data":[],"msg":"Cancel cross-margin TP/SL, trailing, trigger, and chase orders or stop bots before adjusting your leverage."}
```

## 原因
OKX交易所要求：当存在活跃的算法订单（TP/SL、跟踪、触发、追击订单或机器人）时，不允许调整杠杆。

## 解决方案

### 1. 增强的杠杆设置方法 (`set_leverage`)
- 检测特定的算法订单错误码
- 自动保存并取消现有算法订单
- 重新尝试设置杠杆
- 恢复之前保存的算法订单

### 2. 辅助方法

#### `_save_and_cancel_algo_orders`
- 获取当前所有活跃的算法订单
- 保存订单数据以便后续恢复
- 批量取消所有算法订单

#### `_restore_algo_orders`
- 根据保存的数据重新创建算法订单
- 逐个恢复，确保即使部分失败也不影响整体
- 记录恢复结果

### 3. 流程改进
```
尝试设置杠杆
    ↓
失败？是否因算法订单？
    ↓ 是
保存并取消算法订单
    ↓
重新设置杠杆
    ↓
恢复算法订单
```

## 特性

1. **自动处理**：无需手动干预，系统自动处理算法订单冲突
2. **数据安全**：在取消前保存所有订单数据，确保可恢复
3. **容错设计**：即使部分恢复失败，也不影响整体运行
4. **日志清晰**：详细记录每一步操作，便于调试

## 预期效果

1. 初始化时自动处理杠杆设置冲突
2. 保持所有算法订单的连续性
3. 避免因杠杆设置失败导致系统初始化中断
4. 提供更友好的错误处理和恢复机制

## 注意事项

1. 在杠杆调整期间，TP/SL订单会短暂失效
2. 价格剧烈波动时可能存在风险窗口
3. 建议在低波动时段进行杠杆调整

## 日志示例

```
[时间] 设置杠杆失败，存在活跃算法订单: [错误信息]
[时间] 尝试取消算法订单后重新设置杠杆...
[时间] 发现 X 个活跃算法订单，正在取消...
[时间] 已取消 X 个算法订单
[时间] 杠杆设置成功: 10x
[时间] 正在恢复 X 个算法订单...
[时间] 恢复算法订单成功: [订单ID]
```

系统现在能够优雅地处理杠杆设置与算法订单的冲突问题。